<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniSchedule ‚Äî University Timetabling System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@400;500&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --bg:#0d1117; --surface:#161b22; --surface2:#21262d; --surface3:#30363d;
      --accent:#f0a500; --accent2:#e67e22;
      --text:#c9d1d9; --text-dim:#8b949e; --text-bright:#f0f6fc;
      --border:#30363d; --success:#2ea043; --warning:#d29922; --danger:#da3633; --info:#388bfd;
      --sidebar-w:220px; --header-h:56px;
    }
    html,body { height:100%; background:var(--bg); color:var(--text); font-family:'Source Sans 3',sans-serif; font-size:14px; overflow:hidden; }
    #app { display:flex; height:100vh; }
    #sidebar { width:var(--sidebar-w); background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto; }
    .sidebar-logo { padding:20px 16px 14px; border-bottom:1px solid var(--border); }
    .sidebar-logo h1 { font-family:'Playfair Display',serif; font-size:19px; color:var(--accent); font-weight:700; letter-spacing:.5px; }
    .sidebar-logo p { font-size:11px; color:var(--text-dim); margin-top:2px; }
    .nav-section { padding:8px 0; }
    .nav-label { font-size:10px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.5px; padding:8px 16px 4px; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:8px 16px; cursor:pointer; color:var(--text-dim); transition:all .15s; border-left:3px solid transparent; font-size:13.5px; }
    .nav-item:hover { background:var(--surface2); color:var(--text-bright); }
    .nav-item.active { background:rgba(240,165,0,.08); color:var(--accent); border-left-color:var(--accent); }
    .nav-item .icon { width:16px; text-align:center; flex-shrink:0; }
    #main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    #topbar { height:var(--header-h); background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 20px; gap:10px; flex-shrink:0; }
    #topbar h2 { font-family:'Playfair Display',serif; font-size:16px; color:var(--text-bright); flex:1; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); cursor:pointer; font-size:13px; font-family:inherit; transition:all .15s; white-space:nowrap; }
    .btn:hover { background:var(--surface3); color:var(--text-bright); }
    .btn-primary { background:var(--accent); color:#000; border-color:var(--accent); font-weight:600; }
    .btn-primary:hover { background:#d4940a; }
    .btn-danger { border-color:var(--danger); color:var(--danger); }
    .btn-danger:hover { background:rgba(218,54,51,.15); }
    .btn-success { border-color:var(--success); color:var(--success); }
    .btn-success:hover { background:rgba(46,160,67,.15); }
    .btn-sm { padding:4px 10px; font-size:12px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    #content { flex:1; overflow-y:auto; padding:20px; }
    .card { background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
    .card-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
    .card-header h3 { font-size:13px; font-weight:600; color:var(--text-bright); flex:1; }
    .card-body { padding:16px; }
    .data-table { width:100%; border-collapse:collapse; }
    .data-table th { text-align:left; padding:8px 12px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.8px; color:var(--text-dim); border-bottom:1px solid var(--border); background:var(--surface2); white-space:nowrap; }
    .data-table td { padding:9px 12px; border-bottom:1px solid rgba(48,54,61,.5); vertical-align:middle; }
    .data-table tr:hover td { background:rgba(255,255,255,.02); }
    .data-table tr:last-child td { border-bottom:none; }
    .badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:20px; font-size:11px; font-weight:600; background:var(--surface3); color:var(--text); }
    .badge-info { background:rgba(56,139,253,.15); color:var(--info); }
    .badge-success { background:rgba(46,160,67,.15); color:var(--success); }
    .badge-warning { background:rgba(210,153,34,.15); color:var(--warning); }
    .badge-danger { background:rgba(218,54,51,.15); color:var(--danger); }
    .form-group { margin-bottom:14px; }
    .form-label { display:block; font-size:12px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:.8px; margin-bottom:5px; }
    .form-control { width:100%; padding:8px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text-bright); font-size:13.5px; font-family:inherit; transition:border-color .15s; }
    .form-control:focus { outline:none; border-color:var(--accent); }
    select.form-control option { background:var(--surface2); }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(2px); }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:10px; width:560px; max-width:95vw; max-height:90vh; display:flex; flex-direction:column; animation:modalIn .15s ease-out; }
    .modal-lg { width:800px; }
    @keyframes modalIn { from{transform:translateY(-10px);opacity:0} to{transform:translateY(0);opacity:1} }
    .modal-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; }
    .modal-header h3 { font-family:'Playfair Display',serif; font-size:16px; color:var(--text-bright); flex:1; }
    .modal-body { padding:20px; overflow-y:auto; flex:1; }
    .modal-footer { padding:12px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
    .schedule-container { overflow:auto; max-height:calc(100vh - 220px); }
    .schedule-grid { border-collapse:collapse; min-width:100%; }
    .schedule-grid th { padding:6px 10px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.8px; color:var(--text-dim); background:var(--surface2); border:1px solid var(--border); white-space:nowrap; position:sticky; top:0; z-index:10; }
    .schedule-grid td { border:1px solid var(--border); vertical-align:top; }
    .time-label { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--text-dim); padding:4px 8px; background:var(--surface2); white-space:nowrap; position:sticky; left:0; z-index:5; vertical-align:middle; min-width:68px; }
    .schedule-cell { min-height:60px; padding:3px; position:relative; min-width:150px; }
    .schedule-cell.drag-over { background:rgba(240,165,0,.1); outline:2px dashed var(--accent); outline-offset:-2px; }
    .assignment-chip { display:block; padding:4px 7px; border-radius:4px; font-size:11px; cursor:grab; margin-bottom:2px; border-left:3px solid; line-height:1.4; user-select:none; transition:opacity .15s; }
    .assignment-chip:hover { filter:brightness(1.15); }
    .assignment-chip.dragging { opacity:.35; }
    .assignment-chip.conflict { border-color:var(--danger)!important; background:rgba(218,54,51,.2)!important; }
    .assignment-chip.softconflict { border-color:var(--warning)!important; }
    .chip-course { font-weight:600; color:var(--text-bright); }
    .chip-room { color:var(--text-dim); font-size:10px; }
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
    .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:16px; }
    .stat-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.8px; font-weight:600; }
    .stat-value { font-family:'Playfair Display',serif; font-size:28px; color:var(--text-bright); margin-top:4px; }
    .stat-sub { font-size:11px; color:var(--text-dim); margin-top:2px; }
    .search-bar { display:flex; align-items:center; gap:8px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:0 12px; }
    .search-bar input { background:none; border:none; color:var(--text-bright); font-size:13px; font-family:inherit; padding:7px 0; flex:1; outline:none; width:200px; }
    .search-bar input::placeholder { color:var(--text-dim); }
    .progress-bar { height:6px; background:var(--surface3); border-radius:3px; overflow:hidden; }
    .progress-fill { height:100%; background:var(--accent); border-radius:3px; transition:width .3s; }
    .tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin-bottom:16px; }
    .tab { padding:8px 16px; cursor:pointer; font-size:13px; color:var(--text-dim); border-bottom:2px solid transparent; margin-bottom:-1px; transition:all .15s; }
    .tab:hover { color:var(--text); }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .avail-grid { display:grid; grid-template-columns:52px repeat(5,1fr); gap:2px; font-size:11px; }
    .avail-cell { padding:3px 2px; text-align:center; border-radius:3px; cursor:pointer; background:rgba(46,160,67,.12); color:var(--success); border:1px solid rgba(46,160,67,.2); transition:all .1s; }
    .avail-cell.unavail { background:rgba(218,54,51,.12); color:var(--danger); border-color:rgba(218,54,51,.2); }
    .avail-cell.header { background:var(--surface3); color:var(--text-dim); cursor:default; font-weight:600; border-color:var(--border); font-size:10px; }
    #toast-container { position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
    .toast { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 16px; font-size:13px; animation:toastIn .2s ease-out; max-width:320px; display:flex; align-items:center; gap:8px; }
    .toast.success { border-color:var(--success); }
    .toast.error { border-color:var(--danger); }
    .toast.warning { border-color:var(--warning); }
    @keyframes toastIn { from{transform:translateX(20px);opacity:0} to{transform:translateX(0);opacity:1} }
    .solver-panel { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .unassigned-pool { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:8px; max-height:220px; overflow-y:auto; }
    .unassigned-item { padding:5px 8px; border-radius:4px; cursor:grab; font-size:12px; background:var(--surface3); border:1px solid var(--border); margin-bottom:4px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .unassigned-item:hover { border-color:var(--accent); }
    .spinner { width:18px; height:18px; border:2px solid var(--surface3); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; display:inline-block; flex-shrink:0; }
    @keyframes spin { to{transform:rotate(360deg)} }
    #welcome { position:fixed; inset:0; background:var(--bg); z-index:500; display:flex; align-items:center; justify-content:center; }
    .welcome-box { text-align:center; max-width:520px; padding:20px; }
    .welcome-box h1 { font-family:'Playfair Display',serif; font-size:48px; color:var(--accent); margin-bottom:6px; }
    .welcome-box .subtitle { color:var(--text-dim); margin-bottom:8px; font-size:16px; }
    .welcome-box .hint { color:var(--text-dim); margin-bottom:32px; font-size:13px; }
    .welcome-actions { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:var(--surface); }
    ::-webkit-scrollbar-thumb { background:var(--surface3); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--text-dim); }
    .divider { height:1px; background:var(--border); margin:12px 0; }
    .text-dim { color:var(--text-dim); }
    .text-bright { color:var(--text-bright); }
    .text-accent { color:var(--accent); }
    .text-danger { color:var(--danger); }
    .text-success { color:var(--success); }
    .text-warning { color:var(--warning); }
    .mono { font-family:'JetBrains Mono',monospace; }
    .mb-12 { margin-bottom:12px; }
    .mb-16 { margin-bottom:16px; }
    .report-table { width:100%; border-collapse:collapse; font-size:13px; }
    .report-table th,.report-table td { padding:8px 12px; border:1px solid var(--border); text-align:left; }
    .report-table th { background:var(--surface2); font-size:11px; text-transform:uppercase; letter-spacing:.8px; color:var(--text-dim); }
    .filter-bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:10px 0; border-bottom:1px solid var(--border); margin-bottom:12px; }
    .filter-bar select { max-width:160px; }
  </style>
</head>
<body>

<!-- Welcome Screen -->
<div id="welcome">
  <div class="welcome-box">
    <h1>UniSchedule</h1>
    <p class="subtitle">University Course &amp; Room Timetabling System</p>
    <p class="hint">Open a previously saved JSON schedule, or start with sample university data.</p>
    <div class="welcome-actions">
      <label class="btn btn-primary" style="cursor:pointer">
        üìÇ Open JSON File
        <input type="file" id="file-open" accept=".json" style="display:none" onchange="loadFile(this)">
      </label>
      <button class="btn" onclick="loadSampleData()" style="font-size:14px">üéì Load Sample Data</button>
      <button class="btn" onclick="startBlank()">+ New Blank Schedule</button>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <nav id="sidebar">
    <div class="sidebar-logo">
      <h1>UniSchedule</h1>
      <p id="term-label">Fall 2025</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" onclick="navigate('dashboard')" data-view="dashboard"><span class="icon">‚äû</span> Dashboard</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Data</div>
      <div class="nav-item" onclick="navigate('departments')" data-view="departments"><span class="icon">üèõ</span> Departments</div>
      <div class="nav-item" onclick="navigate('rooms')" data-view="rooms"><span class="icon">üö™</span> Rooms</div>
      <div class="nav-item" onclick="navigate('instructors')" data-view="instructors"><span class="icon">üë§</span> Instructors</div>
      <div class="nav-item" onclick="navigate('courses')" data-view="courses"><span class="icon">üìö</span> Courses</div>
      <div class="nav-item" onclick="navigate('sections')" data-view="sections"><span class="icon">üìã</span> Sections</div>
      <div class="nav-item" onclick="navigate('groups')" data-view="groups"><span class="icon">üë•</span> Student Groups</div>
      <div class="nav-item" onclick="navigate('timeslots')" data-view="timeslots"><span class="icon">üïê</span> Time Slots</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Scheduling</div>
      <div class="nav-item" onclick="navigate('schedule')" data-view="schedule"><span class="icon">üìÖ</span> Schedule Builder</div>
      <div class="nav-item" onclick="navigate('solver')" data-view="solver"><span class="icon">‚ö°</span> Auto Solver</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Analysis</div>
      <div class="nav-item" onclick="navigate('reports')" data-view="reports"><span class="icon">üìä</span> Reports</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">File</div>
      <div class="nav-item" onclick="saveJSON()"><span class="icon">üíæ</span> Save JSON</div>
      <div class="nav-item" onclick="navigate('settings')" data-view="settings"><span class="icon">‚öô</span> Settings</div>
    </div>
  </nav>
  <div id="main">
    <div id="topbar">
      <h2 id="page-title">Dashboard</h2>
      <div id="topbar-actions" style="display:flex;gap:8px;align-items:center"></div>
    </div>
    <div id="content"></div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ================================================================
// STATE
// ================================================================
let STATE = {
  meta:{ version:"1.0", institution:"State University", term:"Fall 2025" },
  departments:[], rooms:[], instructors:[], courses:[], sections:[],
  timeSlotPatterns:[], studentGroups:[], constraints:[], assignments:[]
};

let undoStack=[], redoStack=[], currentView='dashboard', dragSectionId=null, solverWorker=null;

const DEPT_COLORS=['#388bfd','#3fb950','#f0a500','#bc8cff','#ff7b72','#ffca3c','#ff851b','#40c8e0'];
const DAYS=['Mon','Tue','Wed','Thu','Fri'];

// ================================================================
// UTILS
// ================================================================
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

function toast(msg, type='success'){
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span>${type==='success'?'‚úì':type==='error'?'‚úó':'‚ö†'}</span> ${msg}`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(),300); }, 3200);
}

function saveHistory(){
  undoStack.push(JSON.stringify(STATE));
  if(undoStack.length>50) undoStack.shift();
  redoStack=[];
}

function undo(){
  if(!undoStack.length) return toast('Nothing to undo','warning');
  redoStack.push(JSON.stringify(STATE));
  STATE=JSON.parse(undoStack.pop());
  navigate(currentView); toast('Undone');
}

function redo(){
  if(!redoStack.length) return toast('Nothing to redo','warning');
  undoStack.push(JSON.stringify(STATE));
  STATE=JSON.parse(redoStack.pop());
  navigate(currentView); toast('Redone');
}

function getDeptColor(deptId){
  const idx=STATE.departments.findIndex(d=>d.id===deptId);
  return idx>=0 ? DEPT_COLORS[idx%DEPT_COLORS.length] : '#8b949e';
}

function getDeptIndex(deptId){ return STATE.departments.findIndex(d=>d.id===deptId); }
function getCourse(id){ return STATE.courses.find(c=>c.id===id); }
function getRoom(id){ return STATE.rooms.find(r=>r.id===id); }
function getInstructor(id){ return STATE.instructors.find(i=>i.id===id); }
function getSection(id){ return STATE.sections.find(s=>s.id===id); }
function getTimeSlot(id){ return STATE.timeSlotPatterns.find(t=>t.id===id); }
function getDept(id){ return STATE.departments.find(d=>d.id===id); }
function assignmentFor(sectionId){ return STATE.assignments.find(a=>a.sectionId===sectionId); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ================================================================
// FILE I/O
// ================================================================
function loadFile(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      STATE=JSON.parse(e.target.result);
      document.getElementById('welcome').style.display='none';
      document.getElementById('app').style.display='flex';
      document.getElementById('term-label').textContent=STATE.meta?.term||'Schedule';
      navigate('dashboard');
      toast('File loaded successfully');
    }catch(err){ toast('Invalid JSON file','error'); }
  };
  reader.readAsText(file);
}

function saveJSON(){
  const blob=new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`schedule-${(STATE.meta.term||'export').replace(/\s+/g,'-')}.json`;
  a.click(); toast('JSON saved');
}

function exportCSV(data, filename){
  if(!data||!data.length) return toast('No data to export','warning');
  const keys=Object.keys(data[0]).filter(k=>k!=='id');
  const csv=[keys.join(','),...data.map(r=>keys.map(k=>JSON.stringify(r[k]??'')).join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  toast('CSV exported');
}

function startBlank(){
  STATE={ meta:{version:"1.0",institution:"My University",term:"Fall 2025"}, departments:[], rooms:[], instructors:[], courses:[], sections:[], timeSlotPatterns:defaultTimeSlots(), studentGroups:[], constraints:[], assignments:[] };
  document.getElementById('welcome').style.display='none';
  document.getElementById('app').style.display='flex';
  navigate('dashboard');
}

// ================================================================
// NAVIGATION
// ================================================================
const VIEW_TITLES={ dashboard:'Dashboard', departments:'Departments', rooms:'Rooms', instructors:'Instructors', courses:'Courses', sections:'Sections', groups:'Student Groups', timeslots:'Time Slot Patterns', schedule:'Schedule Builder', solver:'Auto Solver', reports:'Reports', settings:'Settings' };

function navigate(view){
  currentView=view;
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.toggle('active',el.dataset.view===view));
  document.getElementById('page-title').textContent=VIEW_TITLES[view]||view;
  document.getElementById('content').innerHTML='';
  document.getElementById('topbar-actions').innerHTML='';
  switch(view){
    case 'dashboard': renderDashboard(); break;
    case 'departments': case 'rooms': case 'instructors': case 'courses': case 'sections': case 'groups': case 'timeslots': renderEntityView(view); break;
    case 'schedule': renderSchedule(); break;
    case 'solver': renderSolver(); break;
    case 'reports': renderReports(); break;
    case 'settings': renderSettings(); break;
  }
}

// ================================================================
// ENTITY CONFIG
// ================================================================
const ENTITY_CONFIG={
  departments:{ label:'Department', plural:'Departments', fields:[
    {key:'name',label:'Name',type:'text',required:true},
    {key:'code',label:'Code',type:'text',required:true,mono:true}
  ]},
  rooms:{ label:'Room', plural:'Rooms', fields:[
    {key:'name',label:'Room Name',type:'text',required:true},
    {key:'building',label:'Building',type:'text'},
    {key:'capacity',label:'Capacity',type:'number',required:true},
    {key:'roomType',label:'Room Type',type:'select',options:['lecture_hall','lab','seminar','studio','auditorium','other']},
    {key:'features',label:'Features (comma-separated)',type:'text'}
  ]},
  instructors:{ label:'Instructor', plural:'Instructors', fields:[
    {key:'name',label:'Full Name',type:'text',required:true},
    {key:'deptId',label:'Department',type:'dept'},
    {key:'email',label:'Email',type:'text'},
    {key:'maxLoad',label:'Max Load (hrs/week)',type:'number'}
  ]},
  courses:{ label:'Course', plural:'Courses', fields:[
    {key:'code',label:'Course Code',type:'text',required:true,mono:true},
    {key:'title',label:'Title',type:'text',required:true},
    {key:'deptId',label:'Department',type:'dept'},
    {key:'credits',label:'Credit Hours',type:'number'},
    {key:'enrollment',label:'Expected Enrollment',type:'number'}
  ]},
  sections:{ label:'Section', plural:'Sections', fields:[
    {key:'courseId',label:'Course',type:'course',required:true},
    {key:'sectionNum',label:'Section #',type:'text'},
    {key:'students',label:'Number of Students',type:'number'},
    {key:'roomType',label:'Required Room Type',type:'select',options:['any','lecture_hall','lab','seminar','studio','auditorium']},
    {key:'instructorId',label:'Instructor',type:'instructor'}
  ]},
  groups:{ label:'Student Group', plural:'Student Groups', fields:[
    {key:'name',label:'Group Name',type:'text',required:true},
    {key:'size',label:'Size',type:'number'}
  ]},
  timeslots:{ label:'Time Slot Pattern', plural:'Time Slot Patterns', fields:[
    {key:'name',label:'Pattern Name',type:'text',required:true},
    {key:'days',label:'Days (MWF, TTh, MW‚Ä¶)',type:'text'},
    {key:'startTime',label:'Start Time (HH:MM)',type:'text'},
    {key:'endTime',label:'End Time (HH:MM)',type:'text'},
    {key:'duration',label:'Duration (min)',type:'number'}
  ]}
};

const ENTITY_KEY={ departments:'departments', rooms:'rooms', instructors:'instructors', courses:'courses', sections:'sections', groups:'studentGroups', timeslots:'timeSlotPatterns' };

// ================================================================
// ENTITY CRUD VIEW
// ================================================================
function renderEntityView(view){
  const cfg=ENTITY_CONFIG[view], key=ENTITY_KEY[view], data=STATE[key]||[];
  const ta=document.getElementById('topbar-actions');
  ta.innerHTML=`
    <div class="search-bar"><span>üîç</span><input id="search-${view}" placeholder="Search ${cfg.plural}‚Ä¶" oninput="filterTable('${view}')"></div>
    <button class="btn btn-primary" onclick="openEntityModal('${view}',null)">+ Add ${cfg.label}</button>
    <button class="btn btn-sm" onclick="exportCSV(STATE['${key}'],'${key}.csv')">‚Üì CSV</button>
  `;
  document.getElementById('content').innerHTML=`<div class="card"><div id="table-wrap-${view}">${buildEntityTable(view,data)}</div></div>`;
}

function buildEntityTable(view, data){
  const cfg=ENTITY_CONFIG[view];
  if(!data.length) return `<div style="padding:40px;text-align:center;color:var(--text-dim)">No ${cfg.plural.toLowerCase()} yet. Click "+ Add ${cfg.label}" to create one.</div>`;
  const headers=cfg.fields.map(f=>`<th>${f.label}</th>`).join('');
  const rows=data.map(item=>{
    const cells=cfg.fields.map(f=>{
      let val=item[f.key]??'‚Äî';
      if(f.type==='dept'){ const d=getDept(val); val=d?`<span class="badge">${d.code}</span>`:'‚Äî'; }
      else if(f.type==='course'){ const c=getCourse(val); val=c?`<span class="mono" style="font-size:12px">${c.code}</span>`:'‚Äî'; }
      else if(f.type==='instructor'){ const i=getInstructor(val); val=i?i.name:'‚Äî'; }
      else if(f.mono && val!=='‚Äî') val=`<span class="mono">${escapeHtml(val)}</span>`;
      else val=escapeHtml(String(val));
      return `<td>${val}</td>`;
    }).join('');
    const di=getDeptIndex(item.deptId); const borderStyle=di>=0?`style="border-left:3px solid ${DEPT_COLORS[di%DEPT_COLORS.length]}"`:''
    return `<tr ${borderStyle}>${cells}<td style="text-align:right;white-space:nowrap">
      <button class="btn btn-sm" onclick="openEntityModal('${view}','${item.id}')">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteEntity('${view}','${item.id}')">Delete</button>
    </td></tr>`;
  }).join('');
  return `<table class="data-table"><thead><tr>${headers}<th></th></tr></thead><tbody id="tbody-${view}">${rows}</tbody></table>`;
}

function filterTable(view){
  const q=document.getElementById(`search-${view}`)?.value?.toLowerCase()||'';
  document.querySelectorAll(`#tbody-${view} tr`).forEach(r=>{ r.style.display=r.textContent.toLowerCase().includes(q)?'':'none'; });
}

function deleteEntity(view, id){
  if(!confirm('Delete this item?')) return;
  saveHistory();
  const key=ENTITY_KEY[view];
  STATE[key]=STATE[key].filter(x=>x.id!==id);
  if(view==='rooms') STATE.assignments=STATE.assignments.filter(a=>a.roomId!==id);
  if(view==='sections') STATE.assignments=STATE.assignments.filter(a=>a.sectionId!==id);
  renderEntityView(view); toast('Deleted');
}

// ================================================================
// ENTITY MODAL
// ================================================================
function openEntityModal(view, id){
  const cfg=ENTITY_CONFIG[view], key=ENTITY_KEY[view];
  const item=id?STATE[key].find(x=>x.id===id):null, isNew=!item;
  let fields=cfg.fields.map(f=>{
    const val=item?(item[f.key]??''):'';
    if(f.type==='select'){
      const opts=f.options.map(o=>`<option value="${o}" ${val===o?'selected':''}>${o.replace(/_/g,' ')}</option>`).join('');
      return `<div class="form-group"><label class="form-label">${f.label}</label><select class="form-control" id="field-${f.key}"><option value="">‚Äî Select ‚Äî</option>${opts}</select></div>`;
    }
    if(f.type==='dept'){
      const opts=STATE.departments.map(d=>`<option value="${d.id}" ${val===d.id?'selected':''}>${d.code} ‚Äî ${d.name}</option>`).join('');
      return `<div class="form-group"><label class="form-label">${f.label}</label><select class="form-control" id="field-${f.key}"><option value="">‚Äî None ‚Äî</option>${opts}</select></div>`;
    }
    if(f.type==='course'){
      const opts=STATE.courses.map(c=>`<option value="${c.id}" ${val===c.id?'selected':''}>${c.code}: ${c.title}</option>`).join('');
      return `<div class="form-group"><label class="form-label">${f.label}</label><select class="form-control" id="field-${f.key}"><option value="">‚Äî Select Course ‚Äî</option>${opts}</select></div>`;
    }
    if(f.type==='instructor'){
      const opts=STATE.instructors.map(i=>`<option value="${i.id}" ${val===i.id?'selected':''}>${i.name}</option>`).join('');
      return `<div class="form-group"><label class="form-label">${f.label}</label><select class="form-control" id="field-${f.key}"><option value="">‚Äî None ‚Äî</option>${opts}</select></div>`;
    }
    const mClass=f.mono?'mono':'';
    return `<div class="form-group"><label class="form-label">${f.label}</label><input type="${f.type==='number'?'number':'text'}" class="form-control ${mClass}" id="field-${f.key}" value="${escapeHtml(String(val))}"></div>`;
  }).join('');

  let extra='';
  if(view==='instructors'){
    extra=`<div class="form-group"><label class="form-label">Unavailability ‚Äî click cells to toggle</label><div id="avail-grid-container">${buildAvailGrid(item?.unavailability||{})}</div></div>`;
  }
  if(view==='groups'){
    const all=STATE.courses.map(c=>`<label style="display:flex;align-items:center;gap:6px;margin-bottom:5px;cursor:pointer"><input type="checkbox" value="${c.id}" ${(item?.courseIds||[]).includes(c.id)?'checked':''}> <span class="mono" style="font-size:12px">${c.code}</span> ${escapeHtml(c.title)}</label>`).join('');
    extra=`<div class="form-group"><label class="form-label">Required Courses</label><div style="max-height:160px;overflow-y:auto;padding:10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)" id="group-courses-wrap">${all||'<span class="text-dim">No courses defined yet</span>'}</div></div>`;
  }

  showModal(`${isNew?'Add':'Edit'} ${cfg.label}`, fields+extra, [
    {label:'Cancel',action:'closeModal()'},
    {label:isNew?'Create':'Save',primary:true,action:`saveEntityModal('${view}','${id||''}')`}
  ]);
}

function buildAvailGrid(unavail){
  const hours=['8am','9am','10am','11am','12pm','1pm','2pm','3pm','4pm','5pm'];
  const days=['Mon','Tue','Wed','Thu','Fri'];
  let html=`<div class="avail-grid"><div class="avail-cell header"></div>`;
  days.forEach(d=>{ html+=`<div class="avail-cell header">${d}</div>`; });
  hours.forEach((h,hi)=>{
    html+=`<div class="avail-cell header">${h}</div>`;
    days.forEach(d=>{
      const k=`${d}-${hi+8}`, isU=unavail[k];
      html+=`<div class="avail-cell${isU?' unavail':''}" data-avail-key="${k}" onclick="this.classList.toggle('unavail');this.textContent=this.classList.contains('unavail')?'‚úó':'‚úì'">${isU?'‚úó':'‚úì'}</div>`;
    });
  });
  return html+'</div>';
}

function saveEntityModal(view, id){
  const cfg=ENTITY_CONFIG[view], key=ENTITY_KEY[view];
  const item={};
  for(const f of cfg.fields){
    const el=document.getElementById(`field-${f.key}`); if(!el) continue;
    let val=el.value.trim();
    if(f.type==='number') val=val?Number(val):null;
    if(f.required && (val===null||val==='')) return toast(`${f.label} is required`,'error');
    item[f.key]=val;
  }
  if(view==='instructors'){
    const unavail={};
    document.querySelectorAll('[data-avail-key].unavail').forEach(el=>{ unavail[el.dataset.availKey]=true; });
    item.unavailability=unavail;
  }
  if(view==='groups'){
    item.courseIds=[...document.querySelectorAll('#group-courses-wrap input:checked')].map(el=>el.value);
  }
  saveHistory();
  if(id){ const idx=STATE[key].findIndex(x=>x.id===id); if(idx>=0) STATE[key][idx]={...STATE[key][idx],...item}; }
  else STATE[key].push({id:uid(),...item});
  closeModal(); renderEntityView(view); toast(id?'Updated':'Created');
}

// ================================================================
// MODAL SYSTEM
// ================================================================
let _modalStack=[];
function showModal(title, body, actions=[]){
  const btns=actions.map(a=>`<button class="btn ${a.primary?'btn-primary':''}" onclick="${a.action}">${a.label}</button>`).join('');
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.innerHTML=`<div class="modal"><div class="modal-header"><h3>${title}</h3><button class="btn btn-sm" onclick="closeModal()" style="margin-left:auto">‚úï</button></div><div class="modal-body">${body}</div><div class="modal-footer">${btns}</div></div>`;
  overlay.addEventListener('click',e=>{ if(e.target===overlay) closeModal(); });
  document.body.appendChild(overlay); _modalStack.push(overlay);
}
function closeModal(){ if(_modalStack.length) _modalStack.pop().remove(); }

// ================================================================
// DASHBOARD
// ================================================================
function renderDashboard(){
  const assigned=STATE.assignments.length, total=STATE.sections.length;
  const pct=total?Math.round(assigned/total*100):0;
  const {hard,soft}=detectAllConflicts();
  const unassigned=STATE.sections.filter(s=>!assignmentFor(s.id));

  document.getElementById('content').innerHTML=`
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Departments</div><div class="stat-value">${STATE.departments.length}</div><div class="stat-sub">${STATE.instructors.length} instructors</div></div>
      <div class="stat-card"><div class="stat-label">Sections</div><div class="stat-value">${total}</div><div class="stat-sub">${assigned} assigned (${pct}%)</div></div>
      <div class="stat-card"><div class="stat-label">Rooms</div><div class="stat-value">${STATE.rooms.length}</div><div class="stat-sub">${STATE.timeSlotPatterns.length} time slots</div></div>
      <div class="stat-card"><div class="stat-label">Conflicts</div><div class="stat-value" style="color:${hard.length?'var(--danger)':'var(--success)'}">${hard.length+soft.length}</div><div class="stat-sub">${hard.length} hard ¬∑ ${soft.length} soft</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header"><h3>Schedule Progress</h3><button class="btn btn-sm btn-primary" onclick="navigate('solver')" style="margin-left:auto">Auto-Solve</button></div>
        <div class="card-body">
          <div style="margin-bottom:8px;display:flex;justify-content:space-between"><span class="text-dim">Sections assigned</span><span class="text-bright">${assigned}/${total}</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
          <div style="margin-top:14px">
            ${unassigned.slice(0,6).map(s=>{ const c=getCourse(s.courseId); return `<div style="padding:5px 0;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)"><span class="badge badge-warning">Unassigned</span><span class="mono" style="font-size:12px">${c?c.code:'?'}</span><span class="text-dim">¬ß${s.sectionNum||'1'}</span></div>`; }).join('')}
            ${!unassigned.length?'<div style="color:var(--success);padding:8px 0">‚úì All sections assigned!</div>':''}
            ${unassigned.length>6?`<div class="text-dim" style="padding:5px 0;font-size:12px">‚Ä¶and ${unassigned.length-6} more</div>`:''}
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Conflicts</h3><button class="btn btn-sm" onclick="navigate('reports')" style="margin-left:auto">Full Report</button></div>
        <div class="card-body">
          ${hard.slice(0,5).map(c=>`<div style="padding:5px 0;border-bottom:1px solid var(--border);display:flex;gap:8px"><span class="badge badge-danger">Hard</span><span style="font-size:12px">${c.message}</span></div>`).join('')}
          ${soft.slice(0,3).map(c=>`<div style="padding:5px 0;border-bottom:1px solid var(--border);display:flex;gap:8px"><span class="badge badge-warning">Soft</span><span style="font-size:12px">${c.message}</span></div>`).join('')}
          ${(!hard.length&&!soft.length)?'<div style="color:var(--success);padding:8px 0">‚úì No conflicts detected</div>':''}
        </div>
      </div>
    </div>
  `;
  document.getElementById('topbar-actions').innerHTML=`<button class="btn" onclick="navigate('schedule')">‚Üí Open Schedule Builder</button>`;
}

// ================================================================
// CONFLICT DETECTION
// ================================================================
function detectAllConflicts(){
  const hard=[], soft=[];
  const byTimeRoom={}, byTimeInstructor={};

  STATE.assignments.forEach(a=>{
    const ts=getTimeSlot(a.timeSlotId), sec=getSection(a.sectionId), room=getRoom(a.roomId);
    if(!ts||!sec) return;
    const slots=getSlotKeys(ts);
    slots.forEach(sk=>{
      const rk=`${a.roomId}|${sk}`;
      if(byTimeRoom[rk]&&byTimeRoom[rk]!==a.sectionId){
        hard.push({type:'room_conflict',message:`Room "${room?.name||a.roomId}" double-booked at ${sk}`,aId:a.sectionId,bId:byTimeRoom[rk]});
      } else byTimeRoom[rk]=a.sectionId;
      if(sec.instructorId){
        const ik=`${sec.instructorId}|${sk}`;
        if(byTimeInstructor[ik]&&byTimeInstructor[ik]!==a.sectionId){
          const ins=getInstructor(sec.instructorId);
          hard.push({type:'instructor_conflict',message:`Instructor "${ins?.name||sec.instructorId}" double-booked at ${sk}`,aId:a.sectionId,bId:byTimeInstructor[ik]});
        } else byTimeInstructor[ik]=a.sectionId;
      }
    });
    if(room&&sec.students&&room.capacity&&sec.students>room.capacity){
      const c=getCourse(sec.courseId);
      hard.push({type:'capacity',message:`${sec.students} students exceed ${room.name} capacity (${room.capacity}) ‚Äî ${c?.code||''} ¬ß${sec.sectionNum||'1'}`,aId:a.sectionId});
    }
    if(room&&sec.roomType&&sec.roomType!=='any'&&room.roomType&&room.roomType!==sec.roomType){
      soft.push({type:'room_type',message:`Section needs "${sec.roomType}" but assigned to "${room.roomType}" (${room.name})`,aId:a.sectionId});
    }
    if(sec.instructorId&&ts){
      const ins=getInstructor(sec.instructorId);
      if(ins?.unavailability){
        slots.forEach(sk=>{
          const [d,h]=sk.split('|'); const k=`${d}-${h}`;
          if(ins.unavailability[k]) soft.push({type:'instructor_avail',message:`${ins.name} unavailable at ${d} ${h}:00`,aId:a.sectionId});
        });
      }
    }
  });

  STATE.studentGroups.forEach(g=>{
    const courseIds=g.courseIds||[];
    const groupSecs=STATE.sections.filter(s=>courseIds.includes(s.courseId));
    const gAssignments=groupSecs.map(s=>({sec:s,asgn:assignmentFor(s.id)})).filter(x=>x.asgn);
    for(let i=0;i<gAssignments.length;i++){
      for(let j=i+1;j<gAssignments.length;j++){
        const a=gAssignments[i], b=gAssignments[j];
        const tsA=getTimeSlot(a.asgn.timeSlotId), tsB=getTimeSlot(b.asgn.timeSlotId);
        if(!tsA||!tsB) continue;
        const sA=new Set(getSlotKeys(tsA)), sB=getSlotKeys(tsB);
        if(sB.some(s=>sA.has(s))){
          const cA=getCourse(a.sec.courseId), cB=getCourse(b.sec.courseId);
          hard.push({type:'student_conflict',message:`Group "${g.name}": ${cA?.code||'?'} and ${cB?.code||'?'} overlap`,aId:a.asgn.sectionId,bId:b.asgn.sectionId});
        }
      }
    }
  });
  return {hard,soft};
}

function getSlotKeys(ts){
  if(!ts) return [];
  const days=parseDays(ts.days||'MWF'), startH=parseHour(ts.startTime||'08:00');
  const durH=Math.max(1,Math.ceil((ts.duration||50)/60));
  const keys=[];
  days.forEach(d=>{ for(let h=0;h<durH;h++) keys.push(`${d}|${startH+h}`); });
  return keys;
}

function parseDays(str){
  if(!str) return ['Mon'];
  if(str.includes('MWF')) return ['Mon','Wed','Fri'];
  if(str.includes('TTh')) return ['Tue','Thu'];
  if(str.includes('MW')) return ['Mon','Wed'];
  if(str.includes('TF')) return ['Tue','Fri'];
  if(str.includes('MTWRF')||str.includes('MTWThF')) return DAYS;
  return str.split('').map(c=>({M:'Mon',T:'Tue',W:'Wed',R:'Thu',F:'Fri'}[c])).filter(Boolean);
}

function parseHour(str){ const parts=(str||'8:00').split(':'); return parseInt(parts[0])||8; }

// ================================================================
// SCHEDULE BUILDER
// ================================================================
function renderSchedule(){
  const ta=document.getElementById('topbar-actions');
  ta.innerHTML=`
    <button class="btn btn-sm" onclick="undo()">‚Ü© Undo</button>
    <button class="btn btn-sm" onclick="redo()">‚Ü™ Redo</button>
    <button class="btn btn-sm btn-primary" onclick="navigate('solver')">‚ö° Auto Solver</button>
  `;
  document.getElementById('content').innerHTML=`
    <div class="filter-bar">
      <select class="form-control" id="filter-dept" onchange="renderScheduleGrid()" style="max-width:160px">
        <option value="">All Departments</option>
        ${STATE.departments.map(d=>`<option value="${d.id}">${d.code}</option>`).join('')}
      </select>
      <select class="form-control" id="filter-room" onchange="renderScheduleGrid()" style="max-width:160px">
        <option value="">All Rooms</option>
        ${STATE.rooms.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
      </select>
      <select class="form-control" id="filter-instructor" onchange="renderScheduleGrid()" style="max-width:160px">
        <option value="">All Instructors</option>
        ${STATE.instructors.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}
      </select>
      <span class="text-dim" style="margin-left:auto;font-size:11px">Drag chips to reschedule ‚Ä¢ Click chip to edit</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 270px;gap:14px;align-items:start">
      <div>
        <div class="schedule-container" id="schedule-grid-wrap"></div>
      </div>
      <div>
        <div class="card mb-12">
          <div class="card-header"><h3>Unassigned Sections</h3><span class="badge" id="unassigned-count">0</span></div>
          <div style="padding:8px"><div class="unassigned-pool" id="unassigned-pool"></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Conflicts</h3></div>
          <div id="conflict-list" style="padding:10px;font-size:12px;max-height:220px;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  `;
  renderScheduleGrid();
  renderUnassignedPool();
  renderConflictPanel();
}

function renderScheduleGrid(){
  const wrap=document.getElementById('schedule-grid-wrap'); if(!wrap) return;
  const fDept=document.getElementById('filter-dept')?.value||'';
  const fRoom=document.getElementById('filter-room')?.value||'';
  const fIns=document.getElementById('filter-instructor')?.value||'';
  const hours=Array.from({length:11},(_,i)=>i+8);
  const {hard,soft}=detectAllConflicts();
  const hardSet=new Set(hard.map(c=>[c.aId,c.bId]).flat().filter(Boolean));
  const softSet=new Set(soft.map(c=>[c.aId,c.bId]).flat().filter(Boolean));

  let asgns=STATE.assignments;
  if(fRoom) asgns=asgns.filter(a=>a.roomId===fRoom);
  if(fIns) asgns=asgns.filter(a=>{ const s=getSection(a.sectionId); return s?.instructorId===fIns; });
  if(fDept) asgns=asgns.filter(a=>{ const s=getSection(a.sectionId); const c=getCourse(s?.courseId); return c?.deptId===fDept; });

  let html=`<table class="schedule-grid"><thead><tr><th style="min-width:68px">Time</th>${DAYS.map(d=>`<th style="min-width:155px">${d}</th>`).join('')}</tr></thead><tbody>`;
  hours.forEach(h=>{
    html+=`<tr><td class="time-label">${h<12?h+':00 AM':(h===12?'12:00 PM':(h-12)+':00 PM')}</td>`;
    DAYS.forEach(day=>{
      const cellA=asgns.filter(a=>{ const ts=getTimeSlot(a.timeSlotId); if(!ts) return false; return parseDays(ts.days).includes(day)&&parseHour(ts.startTime)===h; });
      const chips=cellA.map(a=>{
        const sec=getSection(a.sectionId), course=getCourse(sec?.courseId), room=getRoom(a.roomId), ins=getInstructor(sec?.instructorId);
        const di=getDeptIndex(course?.deptId); const color=di>=0?DEPT_COLORS[di%DEPT_COLORS.length]:'#8b949e';
        const isHard=hardSet.has(a.sectionId), isSoft=!isHard&&softSet.has(a.sectionId);
        return `<div class="assignment-chip ${isHard?'conflict':''} ${isSoft?'softconflict':''}"
          style="background:${color}1a;border-left-color:${color}"
          draggable="true"
          ondragstart="onChipDragStart(event,'${a.sectionId}')"
          ondragend="onChipDragEnd(event)"
          onclick="openAssignmentDetail('${a.sectionId}')"
          title="${escapeHtml(course?.title||'')} | ${room?.name||'?'} | ${ins?.name||'No instructor'}">
          <div class="chip-course">${escapeHtml(course?.code||'?')} ¬ß${escapeHtml(sec?.sectionNum||'1')} ${isHard?'‚ö†':''} ${a.locked?'üîí':''}</div>
          <div class="chip-room">${escapeHtml(room?.name||'?')}${ins?' ¬∑ '+ins.name.split(' ').pop():''}</div>
        </div>`;
      }).join('');
      html+=`<td><div class="schedule-cell" ondragover="onCellDragOver(event)" ondragleave="onCellDragLeave(event)" ondrop="onCellDrop(event,'${day}',${h})">${chips}</div></td>`;
    });
    html+=`</tr>`;
  });
  html+=`</tbody></table>`;
  wrap.innerHTML=html;
}

function renderUnassignedPool(){
  const pool=document.getElementById('unassigned-pool'); if(!pool) return;
  const unassigned=STATE.sections.filter(s=>!assignmentFor(s.id));
  const countEl=document.getElementById('unassigned-count');
  if(countEl) countEl.textContent=unassigned.length;
  if(!unassigned.length){ pool.innerHTML=`<div class="text-dim" style="padding:8px;font-size:12px">All sections assigned ‚úì</div>`; return; }
  pool.innerHTML=unassigned.map(s=>{
    const c=getCourse(s.courseId), ins=getInstructor(s.instructorId);
    return `<div class="unassigned-item" draggable="true" ondragstart="onChipDragStart(event,'${s.id}')" ondragend="onChipDragEnd(event)" ondblclick="openQuickAssign('${s.id}')">
      <span class="mono" style="color:var(--accent);font-size:11px">${c?.code||'?'}</span>
      <span>¬ß${s.sectionNum||'1'}</span>
      <span class="text-dim" style="font-size:11px">${s.students||'?'} stu</span>
      ${ins?`<span class="text-dim" style="font-size:11px;margin-left:auto">${ins.name.split(' ').pop()}</span>`:''}
    </div>`;
  }).join('');
}

function renderConflictPanel(){
  const panel=document.getElementById('conflict-list'); if(!panel) return;
  const {hard,soft}=detectAllConflicts();
  if(!hard.length&&!soft.length){ panel.innerHTML=`<div class="text-success">No conflicts ‚úì</div>`; return; }
  panel.innerHTML=[
    ...hard.map(c=>`<div style="padding:3px 0;color:var(--danger)">‚ö† ${escapeHtml(c.message)}</div>`),
    ...soft.map(c=>`<div style="padding:3px 0;color:var(--warning)">‚Ä¢ ${escapeHtml(c.message)}</div>`)
  ].join('');
}

// ================================================================
// DRAG AND DROP
// ================================================================
function onChipDragStart(e, sectionId){
  dragSectionId=sectionId;
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',sectionId);
  setTimeout(()=>{ document.querySelectorAll(`.assignment-chip`).forEach(el=>{ if(el.getAttribute('ondragstart')?.includes(sectionId)) el.classList.add('dragging'); }); },0);
}

function onChipDragEnd(e){
  document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
  dragSectionId=null;
}

function onCellDragOver(e){
  e.preventDefault(); e.dataTransfer.dropEffect='move';
  e.currentTarget.classList.add('drag-over');
}

function onCellDragLeave(e){ e.currentTarget.classList.remove('drag-over'); }

function onCellDrop(e, day, hour){
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
  const sectionId=dragSectionId||e.dataTransfer.getData('text/plain');
  dragSectionId=null;
  if(!sectionId) return;

  // Find matching time slot
  const matchTs=STATE.timeSlotPatterns.find(ts=>{ const d=parseDays(ts.days); return d.includes(day)&&parseHour(ts.startTime)===hour; });
  if(matchTs) openRoomPicker(sectionId, matchTs.id);
  else openQuickAssign(sectionId);
}

function openQuickAssign(sectionId){
  const sec=getSection(sectionId), course=getCourse(sec?.courseId);
  const roomOpts=STATE.rooms.map(r=>`<option value="${r.id}">${escapeHtml(r.name)} (Cap:${r.capacity}, ${r.roomType||'?'})</option>`).join('');
  const tsOpts=STATE.timeSlotPatterns.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} ‚Äî ${t.days} ${t.startTime}</option>`).join('');
  showModal(`Assign ${course?.code||sectionId} ¬ß${sec?.sectionNum||'1'}`, `
    <div class="form-group"><label class="form-label">Room</label><select class="form-control" id="qa-room">${roomOpts||'<option>No rooms defined</option>'}</select></div>
    <div class="form-group"><label class="form-label">Time Slot Pattern</label><select class="form-control" id="qa-ts">${tsOpts||'<option>No patterns defined</option>'}</select></div>
    <div class="form-group"><label class="form-label"><input type="checkbox" id="qa-locked"> Lock this assignment</label></div>
  `, [{label:'Cancel',action:'closeModal()'},{label:'Assign',primary:true,action:`confirmQuickAssign('${sectionId}')`}]);
}

function confirmQuickAssign(sectionId){
  const roomId=document.getElementById('qa-room')?.value, tsId=document.getElementById('qa-ts')?.value, locked=document.getElementById('qa-locked')?.checked||false;
  if(!roomId||!tsId) return toast('Select room and time slot','error');
  saveHistory(); doAssign(sectionId, roomId, tsId, locked);
  closeModal(); refreshScheduleViews(); toast('Assigned');
}

function openRoomPicker(sectionId, tsId){
  const sec=getSection(sectionId), course=getCourse(sec?.courseId), ts=getTimeSlot(tsId);
  const occupied=new Set(STATE.assignments.filter(a=>a.timeSlotId===tsId&&a.sectionId!==sectionId).map(a=>a.roomId));
  const roomOpts=STATE.rooms.map(r=>{
    const occ=occupied.has(r.id), cap=sec?.students&&r.capacity&&sec.students>r.capacity;
    return `<option value="${r.id}" ${occ?'disabled':''} style="${occ?'color:var(--danger)':cap?'color:var(--warning)':''}">
      ${escapeHtml(r.name)} (Cap:${r.capacity}) ${occ?'[Occupied]':cap?'[Too small]':''}</option>`;
  }).join('');
  const cur=assignmentFor(sectionId);
  showModal(`Room for ${course?.code||''} ¬ß${sec?.sectionNum||'1'}`, `
    <p class="text-dim" style="margin-bottom:12px">Time: ${ts?.name||''} ‚Äî ${ts?.days} ${ts?.startTime}‚Äì${ts?.endTime}</p>
    <div class="form-group"><label class="form-label">Room</label><select class="form-control" id="rp-room">${roomOpts||'<option>No rooms defined</option>'}</select></div>
    <div class="form-group"><label class="form-label"><input type="checkbox" id="rp-locked" ${cur?.locked?'checked':''}> Lock this assignment</label></div>
  `, [{label:'Cancel',action:'closeModal()'},{label:'Assign',primary:true,action:`confirmRoomPicker('${sectionId}','${tsId}')`}]);
}

function confirmRoomPicker(sectionId, tsId){
  const roomId=document.getElementById('rp-room')?.value, locked=document.getElementById('rp-locked')?.checked||false;
  if(!roomId) return toast('Select a room','error');
  saveHistory(); doAssign(sectionId, roomId, tsId, locked);
  closeModal(); refreshScheduleViews(); toast('Assigned');
}

function doAssign(sectionId, roomId, tsId, locked=false){
  const idx=STATE.assignments.findIndex(a=>a.sectionId===sectionId);
  const obj={sectionId, roomId, timeSlotId:tsId, locked};
  if(idx>=0) STATE.assignments[idx]=obj; else STATE.assignments.push(obj);
}

function refreshScheduleViews(){
  if(currentView==='schedule'){ renderScheduleGrid(); renderUnassignedPool(); renderConflictPanel(); }
}

function openAssignmentDetail(sectionId){
  const asgn=assignmentFor(sectionId);
  if(!asgn) return openQuickAssign(sectionId);
  const sec=getSection(sectionId), course=getCourse(sec?.courseId), room=getRoom(asgn.roomId), ts=getTimeSlot(asgn.timeSlotId), ins=getInstructor(sec?.instructorId);
  const {hard,soft}=detectAllConflicts();
  const myH=hard.filter(c=>c.aId===sectionId||c.bId===sectionId);
  const myS=soft.filter(c=>c.aId===sectionId||c.bId===sectionId);
  const cHtml=[...myH.map(c=>`<div style="color:var(--danger);margin-top:4px">‚ö† ${escapeHtml(c.message)}</div>`), ...myS.map(c=>`<div style="color:var(--warning);margin-top:4px">‚Ä¢ ${escapeHtml(c.message)}</div>`)].join('');
  showModal(`${course?.code||'?'} ¬ß${sec?.sectionNum||'1'} ‚Äî Assignment`, `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><div class="text-dim" style="font-size:11px">COURSE</div><div class="text-bright">${escapeHtml(course?.title||'?')}</div></div>
      <div><div class="text-dim" style="font-size:11px">INSTRUCTOR</div><div class="text-bright">${escapeHtml(ins?.name||'‚Äî')}</div></div>
      <div><div class="text-dim" style="font-size:11px">ROOM</div><div class="text-bright">${escapeHtml(room?.name||'?')}</div></div>
      <div><div class="text-dim" style="font-size:11px">TIME</div><div class="text-bright">${escapeHtml(ts?.name||'?')} (${ts?.days} ${ts?.startTime})</div></div>
      <div><div class="text-dim" style="font-size:11px">STUDENTS</div><div class="text-bright">${sec?.students||'?'} / ${room?.capacity||'?'}</div></div>
      <div><div class="text-dim" style="font-size:11px">LOCKED</div><div class="text-bright">${asgn.locked?'üîí Yes':'No'}</div></div>
    </div>
    ${cHtml?`<div class="divider"></div>${cHtml}`:''}
  `, [
    {label:'Remove',action:`removeAssignment('${sectionId}')`},
    {label:asgn.locked?'Unlock':'Lock',action:`toggleLock('${sectionId}')`},
    {label:'Reassign',primary:true,action:`closeModal();openQuickAssign('${sectionId}')`},
    {label:'Close',action:'closeModal()'}
  ]);
}

function removeAssignment(sectionId){
  if(!confirm('Remove this assignment?')) return;
  saveHistory();
  STATE.assignments=STATE.assignments.filter(a=>a.sectionId!==sectionId);
  closeModal(); refreshScheduleViews(); toast('Assignment removed');
}

function toggleLock(sectionId){
  const a=assignmentFor(sectionId); if(!a) return;
  saveHistory(); a.locked=!a.locked;
  closeModal(); refreshScheduleViews(); toast(a.locked?'Assignment locked üîí':'Assignment unlocked');
}

// ================================================================
// AUTO SOLVER
// ================================================================
const SOLVER_CODE=`
self.onmessage=function(e){
  const {state,strategy,maxIter}=e.data;
  const result=solve(state,strategy,maxIter);
  self.postMessage({done:true,result});
};
function solve(state,strategy,maxIter){
  const {sections,rooms,timeSlotPatterns,assignments:existing}=state;
  const locked=new Set(existing.filter(a=>a.locked).map(a=>a.sectionId));
  const fixed=existing.filter(a=>a.locked);
  const unassigned=sections.filter(s=>!locked.has(s.id));
  if(!unassigned.length) return {assignments:fixed,placed:0,failed:0};
  unassigned.sort((a,b)=>(b.students||0)-(a.students||0));
  const result=[...fixed];
  const roomOcc={}, instrOcc={};
  fixed.forEach(a=>{
    roomOcc[a.roomId+'|'+a.timeSlotId]=a.sectionId;
    const sec=sections.find(s=>s.id===a.sectionId);
    if(sec?.instructorId) instrOcc[sec.instructorId+'|'+a.timeSlotId]=a.sectionId;
  });
  let placed=0,failed=0;
  for(const sec of unassigned){
    const a=tryAssign(sec,timeSlotPatterns,rooms,roomOcc,instrOcc,state.instructors||[]);
    if(a){ result.push(a); roomOcc[a.roomId+'|'+a.timeSlotId]=sec.id; if(sec.instructorId) instrOcc[sec.instructorId+'|'+a.timeSlotId]=sec.id; placed++; self.postMessage({progress:Math.round(placed/unassigned.length*100),status:'Placing '+placed+'/'+unassigned.length}); }
    else failed++;
  }
  if(strategy==='greedy'){
    const nl=result.filter(a=>!a.locked);
    for(let i=0;i<Math.min(maxIter,800);i++){
      if(nl.length<2) break;
      const ai=Math.floor(Math.random()*nl.length), bi=Math.floor(Math.random()*nl.length);
      if(ai===bi) continue;
      const a=nl[ai],b=nl[bi];
      const sA=sections.find(s=>s.id===a.sectionId), sB=sections.find(s=>s.id===b.sectionId);
      const rA=rooms.find(r=>r.id===a.roomId), rB=rooms.find(r=>r.id===b.roomId);
      if(sA&&sB&&rA&&rB&&roomFits(sA,rB)&&roomFits(sB,rA)){ nl[ai].roomId=rB.id; nl[bi].roomId=rA.id; }
    }
  }
  return {assignments:result,placed,failed};
}
function roomFits(sec,room){
  if(!room) return false;
  if(sec.students&&room.capacity&&sec.students>room.capacity) return false;
  if(sec.roomType&&sec.roomType!=='any'&&room.roomType&&room.roomType!==sec.roomType) return false;
  return true;
}
function tryAssign(sec,tss,rooms,roomOcc,instrOcc,instructors){
  const shuffTS=[...tss].sort(()=>Math.random()-.5);
  const sortedRooms=[...rooms].sort((a,b)=>(a.capacity||0)-(b.capacity||0));
  for(const ts of shuffTS){
    if(sec.instructorId&&instrOcc[sec.instructorId+'|'+ts.id]) continue;
    if(sec.instructorId){
      const ins=instructors.find(i=>i.id===sec.instructorId);
      if(ins?.unavailability){
        const h=parseInt((ts.startTime||'8').split(':')[0]);
        const days=parseDays2(ts.days);
        if(days.some(d=>ins.unavailability[d+'-'+h])) continue;
      }
    }
    for(const r of sortedRooms){
      if(roomOcc[r.id+'|'+ts.id]) continue;
      if(!roomFits(sec,r)) continue;
      return {sectionId:sec.id,roomId:r.id,timeSlotId:ts.id,locked:false};
    }
  }
  return null;
}
function parseDays2(str){
  if(!str) return ['Mon'];
  if(str.includes('MWF')) return ['Mon','Wed','Fri'];
  if(str.includes('TTh')) return ['Tue','Thu'];
  if(str.includes('MW')) return ['Mon','Wed'];
  return ['Mon'];
}
`;

function renderSolver(){
  const {hard,soft}=detectAllConflicts();
  const unassigned=STATE.sections.filter(s=>!assignmentFor(s.id));
  document.getElementById('content').innerHTML=`
    <div class="solver-panel">
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:14px">
        <div><div class="stat-label">Unassigned</div><div class="stat-value" style="font-size:24px">${unassigned.length}</div></div>
        <div><div class="stat-label">Hard Conflicts</div><div class="stat-value" style="font-size:24px;color:${hard.length?'var(--danger)':'var(--success)'}">${hard.length}</div></div>
        <div><div class="stat-label">Soft Conflicts</div><div class="stat-value" style="font-size:24px;color:${soft.length?'var(--warning)':'var(--success)'}">${soft.length}</div></div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="solve-btn" onclick="runSolver()">‚ö° Run Auto Solver</button>
          <button class="btn btn-danger" onclick="clearAllAssignments()">üóë Clear All</button>
          <button class="btn" onclick="clearUnlocked()">Clear Unlocked</button>
        </div>
      </div>
      <div id="solver-progress" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><div class="spinner"></div><span id="solver-status">Initializing‚Ä¶</span></div>
        <div class="progress-bar"><div class="progress-fill" id="solver-pfill" style="width:0%"></div></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header"><h3>Solver Settings</h3></div>
        <div class="card-body">
          <div class="form-group"><label class="form-label">Strategy</label>
            <select class="form-control" id="solver-strategy"><option value="greedy">Greedy + Local Search</option><option value="backtrack">Greedy (no local search)</option></select>
          </div>
          <div class="form-group"><label class="form-label">Max Local Search Iterations</label><input type="number" class="form-control" id="solver-iters" value="1000"></div>
          <div class="form-group"><label class="form-label"><input type="checkbox" id="solver-respect-locked" checked> Respect locked assignments</label></div>
        </div>
      </div>
      <div class="card" id="solver-result" style="display:none">
        <div class="card-header"><h3>Last Result</h3></div>
        <div class="card-body" id="solver-result-body"></div>
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-header"><h3>All Sections</h3><span class="badge">${STATE.sections.length} total</span></div>
      <div style="max-height:320px;overflow-y:auto">
        <table class="data-table">
          <thead><tr><th>Section</th><th>Course</th><th>Students</th><th>Room Type</th><th>Status</th><th>Locked</th></tr></thead>
          <tbody>${STATE.sections.map(s=>{
            const c=getCourse(s.courseId), a=assignmentFor(s.id), r=getRoom(a?.roomId), ts=getTimeSlot(a?.timeSlotId);
            return `<tr><td class="mono">${c?.code||'?'} ¬ß${s.sectionNum||'1'}</td><td>${escapeHtml(c?.title||'‚Äî')}</td><td>${s.students||'‚Äî'}</td><td>${s.roomType||'any'}</td>
              <td>${a?`<span class="badge badge-success">${r?.name||'?'} @ ${ts?.name||'?'}</span>`:'<span class="badge badge-warning">Unassigned</span>'}</td>
              <td>${a?.locked?'üîí':'‚Äî'}</td></tr>`;
          }).join('')}</tbody>
        </table>
      </div>
    </div>
  `;
}

function clearAllAssignments(){
  if(!confirm('Clear all assignments?')) return;
  saveHistory(); STATE.assignments=[]; renderSolver(); toast('All assignments cleared');
}

function clearUnlocked(){
  if(!confirm('Clear all unlocked assignments?')) return;
  saveHistory(); STATE.assignments=STATE.assignments.filter(a=>a.locked); renderSolver(); toast('Unlocked assignments cleared');
}

function runSolver(){
  if(!STATE.timeSlotPatterns.length) return toast('Add time slot patterns first','error');
  if(!STATE.rooms.length) return toast('Add rooms first','error');
  if(!STATE.sections.length) return toast('No sections to assign','warning');
  const strategy=document.getElementById('solver-strategy')?.value||'greedy';
  const maxIter=parseInt(document.getElementById('solver-iters')?.value)||1000;
  document.getElementById('solver-progress').style.display='block';
  document.getElementById('solve-btn').disabled=true;
  const blob=new Blob([SOLVER_CODE],{type:'application/javascript'});
  const url=URL.createObjectURL(blob);
  if(solverWorker){ solverWorker.terminate(); }
  solverWorker=new Worker(url);
  solverWorker.onmessage=e=>{
    if(e.data.progress!==undefined){
      document.getElementById('solver-pfill').style.width=e.data.progress+'%';
      document.getElementById('solver-status').textContent=e.data.status||'Solving‚Ä¶';
    }
    if(e.data.done){
      saveHistory();
      STATE.assignments=e.data.result.assignments;
      document.getElementById('solver-progress').style.display='none';
      document.getElementById('solve-btn').disabled=false;
      URL.revokeObjectURL(url);
      const {hard,soft}=detectAllConflicts();
      const panel=document.getElementById('solver-result'); panel.style.display='block';
      document.getElementById('solver-result-body').innerHTML=`
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
          <div><div class="stat-label">Placed</div><div class="stat-value text-success" style="font-size:22px">${e.data.result.placed}</div></div>
          <div><div class="stat-label">Failed</div><div class="stat-value ${e.data.result.failed?'text-danger':'text-success'}" style="font-size:22px">${e.data.result.failed}</div></div>
          <div><div class="stat-label">Conflicts</div><div class="stat-value ${hard.length?'text-danger':'text-success'}" style="font-size:22px">${hard.length}</div></div>
        </div>
        ${hard.slice(0,4).map(c=>`<div class="text-danger" style="font-size:12px;margin-top:3px">‚ö† ${escapeHtml(c.message)}</div>`).join('')}
        <button class="btn btn-primary" style="margin-top:12px;width:100%" onclick="navigate('schedule')">‚Üí View Schedule</button>
      `;
      toast(`Solver: ${e.data.result.placed} placed, ${e.data.result.failed} failed`);
    }
  };
  solverWorker.onerror=e=>{ toast('Solver error: '+e.message,'error'); document.getElementById('solver-progress').style.display='none'; document.getElementById('solve-btn').disabled=false; };
  solverWorker.postMessage({state:STATE, strategy, maxIter});
}

// ================================================================
// REPORTS
// ================================================================
function renderReports(){
  document.getElementById('content').innerHTML=`
    <div class="tabs">
      <div class="tab active" onclick="switchTab('utilization',this)">Room Utilization</div>
      <div class="tab" onclick="switchTab('load',this)">Instructor Load</div>
      <div class="tab" onclick="switchTab('unassigned',this)">Unassigned</div>
      <div class="tab" onclick="switchTab('conflicts',this)">Conflicts</div>
    </div>
    <div id="report-content"></div>
  `;
  renderRoomUtilReport();
}

function switchTab(tab, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
  if(tab==='utilization') renderRoomUtilReport();
  else if(tab==='load') renderInstructorLoadReport();
  else if(tab==='unassigned') renderUnassignedReport();
  else if(tab==='conflicts') renderConflictsReport();
}

function renderRoomUtilReport(){
  const totalSlots=STATE.timeSlotPatterns.length||1;
  const rows=STATE.rooms.map(r=>{
    const used=STATE.assignments.filter(a=>a.roomId===r.id).length;
    const pct=Math.round(used/totalSlots*100);
    return {name:r.name,building:r.building||'‚Äî',capacity:r.capacity,type:r.roomType||'‚Äî',used,total:totalSlots,pct};
  });
  const exportable=rows.map(r=>({...r}));
  document.getElementById('report-content').innerHTML=`
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px"><button class="btn btn-sm" onclick='exportCSV(${JSON.stringify(exportable)},"room-utilization.csv")'>‚Üì CSV</button></div>
    <table class="report-table"><thead><tr><th>Room</th><th>Building</th><th>Capacity</th><th>Type</th><th>Sessions</th><th>Utilization</th></tr></thead>
    <tbody>${rows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.building)}</td><td>${r.capacity}</td><td>${escapeHtml(r.type)}</td><td>${r.used}/${r.total}</td>
      <td><div style="display:flex;align-items:center;gap:8px"><div class="progress-bar" style="flex:1;max-width:80px"><div class="progress-fill" style="width:${r.pct}%;background:${r.pct>80?'var(--danger)':r.pct>50?'var(--warning)':'var(--success)'}"></div></div>${r.pct}%</div></td></tr>`).join('')}
    </tbody></table>`;
}

function renderInstructorLoadReport(){
  const rows=STATE.instructors.map(i=>{
    const secs=STATE.sections.filter(s=>s.instructorId===i.id);
    const asgnd=secs.filter(s=>assignmentFor(s.id));
    const hrs=asgnd.reduce((sum,s)=>{ const a=assignmentFor(s.id); const ts=getTimeSlot(a?.timeSlotId); return sum+(ts?.duration||50)/60; },0);
    const dept=getDept(i.deptId);
    return {name:i.name,dept:dept?.code||'‚Äî',sections:asgnd.length,hours:hrs.toFixed(1),max:i.maxLoad||'‚Äî',overload:i.maxLoad&&hrs>i.maxLoad};
  });
  document.getElementById('report-content').innerHTML=`
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px"><button class="btn btn-sm" onclick='exportCSV(${JSON.stringify(rows)},"instructor-load.csv")'>‚Üì CSV</button></div>
    <table class="report-table"><thead><tr><th>Instructor</th><th>Dept</th><th>Sections</th><th>Hrs/Week</th><th>Max Load</th><th>Status</th></tr></thead>
    <tbody>${rows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td><span class="badge">${r.dept}</span></td><td>${r.sections}</td><td>${r.hours}</td><td>${r.max}</td>
      <td>${r.overload?'<span class="badge badge-danger">Overloaded</span>':'<span class="badge badge-success">OK</span>'}</td></tr>`).join('')}
    </tbody></table>`;
}

function renderUnassignedReport(){
  const ua=STATE.sections.filter(s=>!assignmentFor(s.id));
  document.getElementById('report-content').innerHTML=`
    <p style="margin-bottom:12px;color:var(--text-dim)">${ua.length} section(s) unassigned</p>
    <table class="report-table"><thead><tr><th>Section</th><th>Course</th><th>Students</th><th>Room Type</th><th>Instructor</th></tr></thead>
    <tbody>${ua.map(s=>{ const c=getCourse(s.courseId),ins=getInstructor(s.instructorId); return `<tr><td class="mono">${c?.code||'?'} ¬ß${s.sectionNum||'1'}</td><td>${escapeHtml(c?.title||'‚Äî')}</td><td>${s.students||'‚Äî'}</td><td>${s.roomType||'any'}</td><td>${escapeHtml(ins?.name||'‚Äî')}</td></tr>`; }).join('')}
    </tbody></table>
    ${!ua.length?'<div class="text-success" style="padding:16px">All sections assigned ‚úì</div>':''}`;
}

function renderConflictsReport(){
  const {hard,soft}=detectAllConflicts();
  document.getElementById('report-content').innerHTML=`
    <h3 style="margin-bottom:8px;font-size:14px">Hard Conflicts (${hard.length})</h3>
    ${hard.length?`<table class="report-table" style="margin-bottom:16px"><thead><tr><th>Type</th><th>Description</th></tr></thead>
      <tbody>${hard.map(c=>`<tr><td><span class="badge badge-danger">${c.type}</span></td><td>${escapeHtml(c.message)}</td></tr>`).join('')}</tbody></table>`:'<div class="text-success" style="padding:8px 0;margin-bottom:16px">No hard conflicts ‚úì</div>'}
    <h3 style="margin-bottom:8px;font-size:14px">Soft Conflicts / Warnings (${soft.length})</h3>
    ${soft.length?`<table class="report-table"><thead><tr><th>Type</th><th>Description</th></tr></thead>
      <tbody>${soft.map(c=>`<tr><td><span class="badge badge-warning">${c.type}</span></td><td>${escapeHtml(c.message)}</td></tr>`).join('')}</tbody></table>`:'<div class="text-success" style="padding:8px 0">No soft conflicts ‚úì</div>'}`;
}

// ================================================================
// SETTINGS
// ================================================================
function renderSettings(){
  document.getElementById('content').innerHTML=`
    <div style="max-width:600px">
      <div class="card mb-16">
        <div class="card-header"><h3>Institution Settings</h3></div>
        <div class="card-body">
          <div class="form-group"><label class="form-label">Institution Name</label><input type="text" class="form-control" id="set-inst" value="${escapeHtml(STATE.meta.institution||'')}"></div>
          <div class="form-group"><label class="form-label">Term</label><input type="text" class="form-control" id="set-term" value="${escapeHtml(STATE.meta.term||'')}"></div>
          <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </div>
      </div>
      <div class="card mb-16">
        <div class="card-header"><h3>File Operations</h3></div>
        <div class="card-body">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="saveJSON()">üíæ Download JSON</button>
            <label class="btn" style="cursor:pointer">üìÇ Load JSON <input type="file" accept=".json" onchange="loadFile(this)" style="display:none"></label>
            <button class="btn btn-danger" onclick="resetAll()">‚ö† Reset All Data</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Keyboard Shortcuts</h3></div>
        <div class="card-body">
          <table style="width:100%">
            ${[['Ctrl+Z','Undo last action'],['Ctrl+Y','Redo'],['Escape','Close modal'],['Ctrl+S','Save JSON']].map(([k,d])=>`<tr><td style="padding:5px 0"><span class="badge mono">${k}</span></td><td style="padding:5px 8px;color:var(--text-dim);font-size:13px">${d}</td></tr>`).join('')}
          </table>
        </div>
      </div>
    </div>
  `;
}

function saveSettings(){
  STATE.meta.institution=document.getElementById('set-inst').value;
  STATE.meta.term=document.getElementById('set-term').value;
  document.getElementById('term-label').textContent=STATE.meta.term;
  toast('Settings saved');
}

function resetAll(){
  if(!confirm('Reset ALL data? This cannot be undone.')) return;
  STATE={ meta:{version:"1.0",institution:"My University",term:"Fall 2025"}, departments:[], rooms:[], instructors:[], courses:[], sections:[], timeSlotPatterns:defaultTimeSlots(), studentGroups:[], constraints:[], assignments:[] };
  navigate('dashboard'); toast('All data reset');
}

// ================================================================
// DEFAULT TIME SLOTS
// ================================================================
function defaultTimeSlots(){
  return [
    {id:uid(),name:'MWF 8am',days:'MWF',startTime:'08:00',endTime:'08:50',duration:50},
    {id:uid(),name:'MWF 9am',days:'MWF',startTime:'09:00',endTime:'09:50',duration:50},
    {id:uid(),name:'MWF 10am',days:'MWF',startTime:'10:00',endTime:'10:50',duration:50},
    {id:uid(),name:'MWF 11am',days:'MWF',startTime:'11:00',endTime:'11:50',duration:50},
    {id:uid(),name:'MWF 12pm',days:'MWF',startTime:'12:00',endTime:'12:50',duration:50},
    {id:uid(),name:'MWF 1pm',days:'MWF',startTime:'13:00',endTime:'13:50',duration:50},
    {id:uid(),name:'MWF 2pm',days:'MWF',startTime:'14:00',endTime:'14:50',duration:50},
    {id:uid(),name:'MWF 3pm',days:'MWF',startTime:'15:00',endTime:'15:50',duration:50},
    {id:uid(),name:'TTh 8am',days:'TTh',startTime:'08:00',endTime:'09:15',duration:75},
    {id:uid(),name:'TTh 9:30am',days:'TTh',startTime:'09:30',endTime:'10:45',duration:75},
    {id:uid(),name:'TTh 11am',days:'TTh',startTime:'11:00',endTime:'12:15',duration:75},
    {id:uid(),name:'TTh 12:30pm',days:'TTh',startTime:'12:30',endTime:'13:45',duration:75},
    {id:uid(),name:'TTh 2pm',days:'TTh',startTime:'14:00',endTime:'15:15',duration:75},
    {id:uid(),name:'TTh 3:30pm',days:'TTh',startTime:'15:30',endTime:'16:45',duration:75},
    {id:uid(),name:'MW Evening 6pm',days:'MW',startTime:'18:00',endTime:'19:15',duration:75}
  ];
}

// ================================================================
// SAMPLE DATA
// ================================================================
function loadSampleData(){
  const depts=[
    {id:uid(),name:'Computer Science',code:'CS'},
    {id:uid(),name:'Mathematics',code:'MATH'},
    {id:uid(),name:'Physics',code:'PHYS'},
    {id:uid(),name:'English',code:'ENG'},
    {id:uid(),name:'Business',code:'BUS'}
  ];
  const rooms=[
    {id:uid(),name:'Turing 101',building:'Turing Hall',capacity:40,roomType:'lecture_hall',features:'projector,whiteboard'},
    {id:uid(),name:'Turing 102',building:'Turing Hall',capacity:30,roomType:'seminar',features:'projector'},
    {id:uid(),name:'Turing Lab A',building:'Turing Hall',capacity:24,roomType:'lab',features:'computers,projector'},
    {id:uid(),name:'Turing Lab B',building:'Turing Hall',capacity:24,roomType:'lab',features:'computers'},
    {id:uid(),name:'Newton 101',building:'Newton Hall',capacity:60,roomType:'lecture_hall',features:'projector,audio'},
    {id:uid(),name:'Newton 102',building:'Newton Hall',capacity:35,roomType:'lecture_hall',features:'projector'},
    {id:uid(),name:'Newton 201',building:'Newton Hall',capacity:20,roomType:'seminar',features:'whiteboard'},
    {id:uid(),name:'Arts 101',building:'Arts Building',capacity:50,roomType:'lecture_hall',features:'projector,audio'},
    {id:uid(),name:'Arts 201',building:'Arts Building',capacity:28,roomType:'seminar',features:'whiteboard'},
    {id:uid(),name:'Business 101',building:'Business Hall',capacity:45,roomType:'lecture_hall',features:'projector,computers'},
    {id:uid(),name:'Business 201',building:'Business Hall',capacity:30,roomType:'seminar',features:'projector'},
    {id:uid(),name:'Main Auditorium',building:'Main Hall',capacity:200,roomType:'auditorium',features:'projector,audio,livestream'},
    {id:uid(),name:'Science Lab A',building:'Science Complex',capacity:20,roomType:'lab',features:'lab_equipment,computers'},
    {id:uid(),name:'Science Lab B',building:'Science Complex',capacity:20,roomType:'lab',features:'lab_equipment,computers'},
    {id:uid(),name:'Study Studio',building:'Library',capacity:15,roomType:'studio',features:'whiteboard'}
  ];
  const instructors=[
    {id:uid(),name:'Dr. Alice Chen',deptId:depts[0].id,email:'achen@uni.edu',maxLoad:12,unavailability:{'Mon-8':true,'Fri-16':true}},
    {id:uid(),name:'Dr. Bob Nguyen',deptId:depts[0].id,email:'bnguyen@uni.edu',maxLoad:12,unavailability:{}},
    {id:uid(),name:'Prof. Carol Davis',deptId:depts[1].id,email:'cdavis@uni.edu',maxLoad:15,unavailability:{'Tue-8':true}},
    {id:uid(),name:'Dr. David Kim',deptId:depts[1].id,email:'dkim@uni.edu',maxLoad:12,unavailability:{}},
    {id:uid(),name:'Prof. Eve Thompson',deptId:depts[2].id,email:'ethompson@uni.edu',maxLoad:12,unavailability:{'Thu-15':true,'Thu-16':true}},
    {id:uid(),name:'Dr. Frank Liu',deptId:depts[2].id,email:'fliu@uni.edu',maxLoad:12,unavailability:{}},
    {id:uid(),name:'Prof. Grace Wilson',deptId:depts[3].id,email:'gwilson@uni.edu',maxLoad:15,unavailability:{'Fri-8':true}},
    {id:uid(),name:'Dr. Henry Brown',deptId:depts[3].id,email:'hbrown@uni.edu',maxLoad:12,unavailability:{}},
    {id:uid(),name:'Prof. Iris Patel',deptId:depts[4].id,email:'ipatel@uni.edu',maxLoad:12,unavailability:{}},
    {id:uid(),name:'Dr. James Taylor',deptId:depts[4].id,email:'jtaylor@uni.edu',maxLoad:15,unavailability:{'Mon-15':true}}
  ];
  const courses=[
    {id:uid(),code:'CS101',title:'Intro to Programming',deptId:depts[0].id,credits:3,enrollment:35},
    {id:uid(),code:'CS201',title:'Data Structures',deptId:depts[0].id,credits:3,enrollment:28},
    {id:uid(),code:'CS301',title:'Algorithms',deptId:depts[0].id,credits:3,enrollment:22},
    {id:uid(),code:'CS350',title:'Database Systems',deptId:depts[0].id,credits:3,enrollment:25},
    {id:uid(),code:'CS401',title:'Operating Systems',deptId:depts[0].id,credits:3,enrollment:20},
    {id:uid(),code:'MATH101',title:'Calculus I',deptId:depts[1].id,credits:4,enrollment:45},
    {id:uid(),code:'MATH102',title:'Calculus II',deptId:depts[1].id,credits:4,enrollment:38},
    {id:uid(),code:'MATH201',title:'Linear Algebra',deptId:depts[1].id,credits:3,enrollment:30},
    {id:uid(),code:'MATH301',title:'Diff. Equations',deptId:depts[1].id,credits:3,enrollment:25},
    {id:uid(),code:'PHYS101',title:'Physics I',deptId:depts[2].id,credits:4,enrollment:50},
    {id:uid(),code:'PHYS102',title:'Physics II',deptId:depts[2].id,credits:4,enrollment:40},
    {id:uid(),code:'PHYS301',title:'Quantum Mechanics',deptId:depts[2].id,credits:3,enrollment:18},
    {id:uid(),code:'ENG101',title:'English Composition',deptId:depts[3].id,credits:3,enrollment:25},
    {id:uid(),code:'ENG201',title:'Literature Survey',deptId:depts[3].id,credits:3,enrollment:30},
    {id:uid(),code:'ENG301',title:'Creative Writing',deptId:depts[3].id,credits:3,enrollment:20},
    {id:uid(),code:'BUS101',title:'Principles of Management',deptId:depts[4].id,credits:3,enrollment:40},
    {id:uid(),code:'BUS201',title:'Marketing Fundamentals',deptId:depts[4].id,credits:3,enrollment:35},
    {id:uid(),code:'BUS301',title:'Financial Accounting',deptId:depts[4].id,credits:3,enrollment:30},
    {id:uid(),code:'BUS401',title:'Strategic Management',deptId:depts[4].id,credits:3,enrollment:25}
  ];
  const sections=[];
  const sData=[
    [0,35,'lecture_hall',0],[0,30,'lecture_hall',1],[1,28,'lecture_hall',0],[2,22,'lab',1],
    [3,25,'lab',0],[4,20,'lecture_hall',1],[5,45,'lecture_hall',2],[5,40,'lecture_hall',3],
    [6,38,'lecture_hall',2],[7,30,'lecture_hall',3],[8,25,'seminar',2],[9,50,'lecture_hall',4],
    [9,45,'lecture_hall',5],[10,40,'lecture_hall',4],[11,18,'seminar',5],[12,25,'seminar',6],
    [13,30,'lecture_hall',7],[14,20,'seminar',6],[15,40,'lecture_hall',8],[15,35,'lecture_hall',9],
    [16,35,'lecture_hall',8],[17,30,'seminar',9],[18,25,'seminar',8]
  ];
  sData.forEach(([ci,students,roomType,ii],i)=>{
    sections.push({ id:uid(), courseId:courses[ci].id, sectionNum:String(sections.filter(s=>s.courseId===courses[ci].id).length+1), students, roomType, instructorId:instructors[Math.min(ii,instructors.length-1)].id });
  });
  const ts=defaultTimeSlots();
  const studentGroups=[
    {id:uid(),name:'CS Freshmen',size:35,courseIds:[courses[0].id,courses[5].id,courses[9].id,courses[12].id]},
    {id:uid(),name:'CS Sophomores',size:28,courseIds:[courses[1].id,courses[6].id,courses[7].id]},
    {id:uid(),name:'Math Majors',size:30,courseIds:[courses[5].id,courses[6].id,courses[7].id,courses[8].id]},
    {id:uid(),name:'Business Cohort A',size:40,courseIds:[courses[15].id,courses[16].id,courses[17].id]}
  ];
  STATE={ meta:{version:"1.0",institution:"State University",term:"Fall 2025"}, departments:depts, rooms, instructors, courses, sections, timeSlotPatterns:ts, studentGroups, constraints:[], assignments:[] };
  document.getElementById('welcome').style.display='none';
  document.getElementById('app').style.display='flex';
  document.getElementById('term-label').textContent=STATE.meta.term;
  navigate('dashboard');
  toast('Sample data loaded! Try "Auto Solver" to assign all sections.');
}

// ================================================================
// KEYBOARD SHORTCUTS
// ================================================================
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') closeModal();
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){ e.preventDefault(); undo(); }
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){ e.preventDefault(); redo(); }
  if((e.ctrlKey||e.metaKey)&&e.key==='s'){ e.preventDefault(); if(document.getElementById('app').style.display!=='none') saveJSON(); }
});
</script>
</body>
</html>
